---
title: "PLATCOV Statistical Analysis Plan"
author: "James Watson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)

library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = 6)

library(RColorBrewer)
library(censReg)
```

TODO list:

* Add QC analysis (comparison of standard curves)
* Up and down model to account for the fact that subjects are in an increasing phase
* Data need to be also on the log viral copies per ml
* How much variance explained by the RNaseP
* Check missing data (vaccine/serology/age)
* Subgroup analysis model for temporal shift
* Define Epochs for the trial to get drift effects
* Model comparison using loo package

## Preambule

This Statistical Analysis Plan (SAP) is written for the PLATCOV trial (registered at ClinicalTrials.gov: https://clinicaltrials.gov/ct2/show/NCT05041907).

Data preparation is done in a different R script called data_prep.R.
This Markdown script assumes that the data are saved in two .csv file in long format. 

The first file interim_control_dat.csv contains the PCR quality control data: CT values from the control samples from each plate (duplicate control samples of known viral densities over the range 100 to 10^7/mL viral copies per mL). This has the following headers:

- ID: unique control ID
- Plate: unique Plate ID for the PCR assay
- CT_NS: observed Ct value for the N/S gene
- log10_true_density: number of viral copies in control sample (log10 scale)

The second file interim_dat.csv contains the patient viral load data with the following column headers:

- ID: anonymised patient id code
- BARCODE: unique sample id code (in the following format: PLT-site-number-swab type-timepoint)
- Swab_ID: RTS or TSL (right versus left tonsil)
- Plate: unique Plate ID for the PCR assay (matching with plate identifiers in interim_control_dat.csv)
- Site: site at enrollment
- Trt: treatment allocation as written in CRF
- Time: time from randomisation
- Variant: variant of concern (using standard WHO terminology for the main lineages, reference will be the predominant variant in the dataset at the start of the study)
- Vaccinated: 0/1 (1: any number of doses and any manufacturer)
- Vaccine_type: manufacturer of vaccine dose 1 (AZ: astra zeneca; SPH: sinopharm; SV: sinovac; MD: moderna; PZ: pfizer)
- Antibody_test: 0/1 (positive/negative for SARS-CoV-2 antibody rapid test)
- Age: (years - has to be between 18-50)
- Sex: 0/1 (male: 1; female/other: 0)
- Symptom_onset: time since onset of symptoms (days)
- CT_NS: observed Ct value for the N/S gene
- CT_RNaseP: observed Ct value for the human RNase P gene
- log10_viral_load: log10 number of viral copies per mL (estimated from plat specific standard curve)


## Setup

```{r}
## parameters for the analysis
Dmax = 8
RUN_MODELS = T

## information on software/hardware used
version
sessionInfo()
```


## Load data and provide data summaries

```{r load_data}
platcov_dat = read.csv('interim_dat.csv')
control_dat = read.csv('interim_control_dat.csv')

IDs = unique(platcov_dat$ID)
platcov_dat$Delta_CT = 40 - platcov_dat$CT_NS

writeLines(sprintf('We have %s PCR datapoints on %s patients from %s sites',
                   length(unique(platcov_dat$BARCODE)),
                   length(IDs),
                   length(unique(platcov_dat$Site))))

ind_dup = !duplicated(platcov_dat$ID)
table(Arm=platcov_dat$Trt[ind_dup], Site = platcov_dat$Site[ind_dup])

platcov_dat$Day = round(platcov_dat$Time)
platcov_dat$Trt_number = as.numeric(as.factor(platcov_dat$Trt))

writeLines('Age distribution of patients:')
print(aggregate(Age ~ Site, platcov_dat[ind_dup, ], 
                function(x) c(mean = round(mean(x)), min = min(x), max = max(x))))

writeLines('Proportion male (%):')
print(aggregate(Sex ~ Site, platcov_dat[ind_dup, ], function(x) round(100*mean(x))))
print('!! WARNING - sex data made up as not in current clinical database that was sent !!')

writeLines('Proportion vaccinated (%):')
print(aggregate(Vaccinated ~ Site, platcov_dat[ind_dup, ], function(x) round(100*mean(x))))

writeLines('Vaccine type by site:')
table(Site=platcov_dat$Site[ind_dup], platcov_dat$Vaccine_type[ind_dup])

writeLines('Number of days since symptom onset by site:')
table(Site=platcov_dat$Site[ind_dup], Sympom_Onset_days = platcov_dat$Symptom_onset[ind_dup])

# baseline samples: taken within 6 hours of randomisation
baseline_ind = platcov_dat$Time < 6/24
writeLines('Number of baseline viral load samples:')
table(platcov_dat$ID[baseline_ind])
bvl = aggregate(log10_viral_load ~ ID, platcov_dat[baseline_ind, ], median)
nrow(bvl) == length(IDs)

writeLines(sprintf('In the %s patients, the geometric mean baseline (defined as samples taken within 6 hours of randomisation) viral load was %s copies per mL (95 percentile interval from %s to %s; range from %s to %s)',
                   length(IDs),
                   round(10^mean(bvl$log10_viral_load)),
                   round(10^(mean(bvl$log10_viral_load)-1.96*sd(bvl$log10_viral_load))),
                   round(10^(mean(bvl$log10_viral_load)+1.96*sd(bvl$log10_viral_load))),
                   round(min(10^bvl$log10_viral_load)),
                   round(max(10^bvl$log10_viral_load))))
par(las=1, cex.lab=1.3, cex.axis=1.3, family='serif')
hist(bvl$log10_viral_load,
     xlab='Log10 viral copies per mL',
     ylab ='Number of patients',
     main='Baseline viral load')
```

## Data visualisation

### Quality Control for PCR

```{r PCR_QC}
par(las=1, mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3,family='serif')
plot(control_dat$log10_true_density,control_dat$CT_NS, 
     ylab='CT value', 
     xlab='Control viral density (log10 copies/mL)',
     panel.first=grid(),
     col=as.numeric(as.factor(control_dat$Plate)), ylim=c(18,40))
my_slope_coefs = array(dim = c(length(unique(control_dat$Plate)),2))

for(ss in unique(control_dat$Plate)){
  plate_ind = control_dat$Plate==ss
  mod = lm(CT_NS~log10_true_density, control_dat[plate_ind, ])
  abline(mod,col = control_dat$Plate[plate_ind])
  my_slope_coefs[which(ss==unique(control_dat$Plate)),]=coef(mod)
}

hist(my_slope_coefs[,1], xlab='Intercept', main='')
writeLines(sprintf('SD of the intercept is %s',round(sd(my_slope_coefs[,1]),2)))

hist(my_slope_coefs[,2], xlab='Slope', main='')
writeLines(sprintf('Maximum difference in CT values for a tenfold change in viral load is %s',round(diff(range(my_slope_coefs[,2])),2)))
# writeLines(sprintf('SD of the intercept is %s',sd(my_slope_coefs[,1])))


xx = aggregate(CT_NS ~ Plate + log10_true_density, 
               data = control_dat, 
               function(x) c(mean(x), diff(x)))
par(las=1)
plot(xx$CT[,1], xx$CT[,2], 
     xlab = 'Mean CT',
     ylab = 'CT Difference from duplicates',
     panel.first=grid())
abline(h = 0)

xx$Mean_CT = cut(xx$CT[,1],breaks = seq(20, 40, by=5),include.lowest = T)
xx$Diff_CT = xx$CT[,2]

par(mfrow=c(1,1))
yy = aggregate(Diff_CT ~ Mean_CT, xx, sd)
plot(yy$Mean_CT, sqrt(2) * yy$Diff_CT, xlab='CT interval',
     ylab = 'Estimated measurement error (standard deviation)')
```



### Overall data

```{r trt_data_plot}
par(las=1, cex.lab=1.3, cex.axis=1.3,family='serif')
## Color by randomised treatment
# make treatment colors and indices
PCR_dat = aggregate(CT_NS ~ ID + Day + Trt + Site + Trt_number, 
                    data = platcov_dat,
                    FUN = function(x) c(mean=mean(x), 
                                        diff=max(x)-min(x),
                                        n = length(x)))

trt_cols = brewer.pal(n = length(unique(PCR_dat$Trt)),name = 'Dark2')

trt_smmry = aggregate(formula = CT_NS ~ Day+Trt_number, 
                      data = platcov_dat,
                      FUN = median)

plot(PCR_dat$Day, PCR_dat$CT_NS[,'mean'],  ylab='CT',
     xlab = 'Time since randomisation (days)',panel.first=grid(),
     xlim = c(0,7), type='n',
     col = trt_cols[PCR_dat$Trt_number],
     ylim = c(40, min(PCR_dat$CT_NS[,'mean'])))
for(id in IDs){
  ind = PCR_dat$ID==id
  lines(PCR_dat$Day[ind], PCR_dat$CT_NS[ind,'mean'],
        col=adjustcolor(trt_cols[PCR_dat$Trt_number[ind]],.3))
}
points(trt_smmry$Day, trt_smmry$CT_NS,
       col= trt_cols[trt_smmry$Trt_number],
       pch = 14+trt_smmry$Trt_number, cex=1.5)
for(tt in unique(trt_smmry$Trt_number)){
  ind = trt_smmry$Trt_number==tt
  lines(trt_smmry$Day[ind], trt_smmry$CT_NS[ind], col = trt_cols[tt])
}
legend('topright', col=trt_cols, 
       legend = unique(PCR_dat$Trt),title = 'Median',
       lwd=2,pch=14+unique(PCR_dat$Trt_number),inset = 0.03)

```


### RNaseP

```{r RNaseP}
par(las=1, cex.lab=1.3, cex.axis=1.3,family='serif')
hist(platcov_dat$CT_RNaseP, main='RNaseP quantification',
     xlab='CT',ylab='',yaxt='n', breaks = 30)
abline(v = mean(platcov_dat$CT_RNaseP) + c(1.96,-1.96)*sd(platcov_dat$CT_RNaseP),
       lwd=3, lty=2)
writeLines(sprintf('the standard deviation of the RNaseP CT distribution is %s.', 
                   round(sd(platcov_dat$CT_RNaseP),2)))

writeLines(sprintf('95%% of the distribution is within %s CT values difference',
                   round(diff(mean(platcov_dat$CT_RNaseP) + c(-1.96,1.96)*sd(platcov_dat$CT_RNaseP)),2)))
```


## Model fitting


Main models: Bayesian hierarchical models with and without covariate adjustment. All models adjust for human RNaseP quantification (scaled to have mean 0).

Covariates that we use in model 2:

* Vaccination (yes/no)
* Time since symptom onset (days)
* Variant (made up data)
* Serology rapid test (+/-)



### Specify priors

```{r priors}
my_priors = list(A0_prior_mean=18,
                 A0_prior_sd = 5,
                 alpha_prior_mean = -2,
                 alpha_prior_sd = 2,
                 sigma_trt_effect=.5)
print(my_priors)
```


### Prepare model

make stan data set

```{r}
trts = c("Regeneron",
         "Ivermectin",
         "Remdesivir",
         "Favipiravir")
platcov_dat$Trt_code = 
  factor(platcov_dat$Trt,
         levels=c("No study drug", trts))

ind_fitting = platcov_dat$Time < Dmax 
writeLines(sprintf('Total number of datapoints up until day %s is %s',Dmax, sum(ind_fitting)))

platcov_dat$RnaseP_scaled = t(scale(40 - platcov_dat$CT_RNaseP, scale = F))[1,] 

stan_data = list(N = sum(ind_fitting),
                 n_id = length(unique(platcov_dat$ID[ind_fitting])),
                 id = as.numeric(as.factor(platcov_dat$ID[ind_fitting])),
                 obs_day = platcov_dat$Time[ind_fitting],
                 delta_CT = platcov_dat$Delta_CT[ind_fitting], 
                 K_trt = length(unique(platcov_dat$Trt[ind_fitting]))-1,
                 trt = as.numeric(platcov_dat$Trt_code[ind_fitting]),
                 RNaseP = platcov_dat$RnaseP_scaled[ind_fitting],
                 K_plate = max(platcov_dat$Plate[ind_fitting]),
                 id_plate = platcov_dat$Plate[ind_fitting],
                 N_control = nrow(control_dat),
                 control_density = control_dat$log10_true_density,
                 control_delta_CT = 40-control_dat$CT_NS,
                 cont_id_plate = control_dat$Plate)


X_matrix = model.matrix( ~ Antibody_test + Symptom_onset, 
                         data = platcov_dat[ind_fitting, ])[, -1]
```

### Run models

To make sure there are no bugs in the code (all stan code is written specifically for this trial analysis), I fit a sequence of five models of increasing complexity:

* Model 0: vanilla student-t regression with left censoring at 0 and with individual random effects for slope and intercept;
* Model 1: vanilla + RNaseP;
* Model 2: vanilla + RNaseP + batch adjustment (no control samples);
* Model 3: vanilla + RNaseP + full batch adjustment (decomposition of variance into intrinsic and biological);
* Model 4: Whole shebang with covariate adjustment


```{r compile_stan_models}
# compile models in stan
if(RUN_MODELS){
  t_model_0 = stan_model(file = 'Linear_model_tdist_M0.stan')
  lin_mod_cov = stan_model(file = 'Linear_model_cov_tdist.stan')
}
```

```{r run_models}
cov_data = list(K_cov = ncol(X_matrix),
                x = X_matrix)
Niter = 4000
Nthin = 10
Nchain = 4

writeLines(sprintf('We are running %s chains with %s samples each, discarding half for burn-in and thining every %s',Nchain,Niter,Nthin))

if(RUN_MODELS){
  # no covariate adjustment
  out_1 = sampling(lin_mod, data=c(stan_data, my_priors), 
                 iter=Niter,chain=Nchain,thin=Nthin)
  
  # no covariate adjustment - no RNaseP adjustment
  stan_data_prime = stan_data
  stan_data_prime$RNaseP = rep(0, stan_data_prime$N)
  out_prime = sampling(lin_mod, data=c(stan_data_prime, my_priors), 
                       iter=Niter,chain=Nchain,thin=Nthin)
  
  # covariate adjustment
  out_cov = sampling(lin_mod_cov, data=c(stan_data, 
                                         cov_data,
                                         my_priors),
                     iter=Niter,chain=Nchain,thin=Nthin)
  
  # save output
  save(out, out_cov, out_prime, file = 'Rout/model_fits.RData')
} else {
  load(file = 'Rout/model_fits.RData')
}
```

### Model fits: summaries

```{r summary}
key_pars = c('A0','alpha','trt_effect','sigmaCT',
             't_dof','gamma_rnasep','sigma_plate','sigmasq_u')
cov_pars = c('beta_intercept','beta_slope')
summary(out,pars=key_pars)$summary[, 1:3]
summary(out_prime,pars=key_pars)$summary[, 1:3]
summary(out_cov,pars=key_pars)$summary[, 1:3]

traceplot(out, pars = key_pars)
traceplot(out_cov, pars = key_pars)
traceplot(out_cov, pars = cov_pars)
```


## Results

### Estimated treatment effects: no covariate adjustment

Posterior distributions over the treatment effects for the interventions. Red: no effect; blue: median inferred effect.

```{r treatment_effects}
thetas = extract(out)
thetas_prime = extract(out_prime)

xx = exp(colMeans(thetas$trt_effect))
names(xx)= trts
print(xx)

par(mfrow=c(2,2), bty='n', cex.lab=1.3, cex.axis=1.3,family='serif')
for(i in 1:4) {
  plot(density(exp(thetas$trt_effect[,i])),yaxt='n',ylab='',
       main=trts[i],xlim = range(exp(thetas$trt_effect)),
       xlab = 'Slope increase (multiplicative)',lwd=3) 
  abline(v=1, lty=2, lwd=3, col='red'); 
  abline(v=median(exp(thetas$trt_effect[,i])), lty=2, lwd=3, col='blue'); 
  writeLines(sprintf('Probability that %s increases the viral clearance slope by more than 5%%: %s',
                     trts[i],
                     round(mean(exp(thetas$trt_effect[,i]) > 1.05),2)))
}

legend('topright', col=c('red','blue'),lwd = 3, lty=2, legend = c('No effect','Median estimate'))
```


### Estimated treatment effects: with covariate adjustment


Posterior distributions over the treatment effects for the interventions, after adjustment for the key covariates (. Red: no effect; blue: median inferred effect.

```{r treatment_effects_cov_model}
thetas_cov = extract(out_cov)
xx = exp(colMeans(thetas_cov$trt_effect))
names(xx)= trts
print(xx)

par(mfrow=c(2,2), bty='n', cex.lab=1.3, cex.axis=1.3,family='serif')
for(i in 1:4) {
  plot(density(exp(thetas_cov$trt_effect[,i])),yaxt='n',ylab='',
       main=trts[i],xlim = range(exp(thetas_cov$trt_effect)),
       xlab = 'Slope increase (multiplicative)',lwd=3) 
  abline(v=1, lty=2, lwd=3, col='red'); 
  abline(v=median(exp(thetas_cov$trt_effect[,i])), lty=2, lwd=3, col='blue'); 
  writeLines(sprintf('Probability that %s increases the viral clearance slope by more than 5%%: %s',
                     trts[i],
                     round(mean(exp(thetas_cov$trt_effect[,i]) > 1.05),2)))
}

legend('topright', col=c('red','blue'),lwd = 3, lty=2, legend = c('No effect','Median estimate'))
```

### Estimated covariate effects

#### RNaseP

Gamma is the parameter

```{r, fig.height=6}
par(mfrow=c(1,2), cex.lab=1.3, cex.axis=1.3,family='serif')
hist(thetas$gamma_rnasep, xlab=expression(gamma),
     main='No covariates model', ylab='', yaxt='n', breaks=30)

hist(thetas_cov$gamma_rnasep, xlab=expression(gamma),
     main='Covariates model', ylab='', yaxt='n', breaks=30)
```



#### Other covariates

```{r cov_effects}
par(mfrow=c(2,2), cex.lab=1.3, cex.axis=1.3,family='serif')
for(j in 1:ncol(X_matrix)){
  hist(thetas_cov$beta_intercept[,j],
       main= paste(colnames(X_matrix)[j],'(Intercept)'),
       xlab='Intercept effect', yaxt='n', ylab='')
  abline(v=0,lwd=3,col='red')
  hist(thetas_cov$beta_slope[,j],
       main= paste(colnames(X_matrix)[j],'(Slope)'),
       xlab='Slope effect', yaxt='n', ylab='')
  abline(v=0,lwd=3,col='red')
}
```

### Individual fits

Individual plots. Thick line no covariate adjustment; dashed line covariate adjustment.


```{r individ_fits}
par(las=1, mfrow=c(3,3), mar=c(4,3,1,1),bty='n', cex.lab=1.3, cex.axis=1.3,family='serif')
for(id in unique(stan_data$id)){
  ind = stan_data$id==id
  plot(stan_data$obs_day[ind],
       40-stan_data$delta_CT[ind],xlab='', ylab='',panel.first=grid(),
       ylim = c(40, min(platcov_dat$CT_NS)))
  lines(stan_data$obs_day[ind], 40-colMeans(thetas$pred_CT_mean[,ind]))
  lines(stan_data$obs_day[ind], 40-colMeans(thetas_cov$pred_CT_mean[,ind]),lty=2)
  mtext(text = IDs[id], side = 3, line = -1)
}
```


## Sensitivity analysis

### Left vs right tonsil

```{r left_versus_right}
par(las=1, bty='n', cex.lab=1.3, cex.axis=1.3,family='serif')


ind = PCR_dat$CT_NS[,'n']==2
plot(PCR_dat$CT_NS[ind,'mean'], PCR_dat$CT_NS[ind,'diff'], 
     xlab = 'Mean CT', ylab='Difference',
     main='Left vs Right tonsil',panel.first=grid())

par(mfrow=c(4,4), mar=c(2,3,1,1))
for(id in IDs){
  ind_right = platcov_dat$Swab_ID=='RTS'&
    platcov_dat$ID==id
  ind_left = platcov_dat$Swab_ID=='TSL'&
    platcov_dat$ID==id
  
  plot(platcov_dat$Time[ind_right], 
       platcov_dat$CT_NS[ind_right],type='b',
       panel.first=grid(),
       ylim = c(40, 10),main='',ylab='',xlab='')
  lines(platcov_dat$Time[ind_left], 
        platcov_dat$CT_NS[ind_left],col='red')
  points(platcov_dat$Time[ind_left], 
         platcov_dat$CT_NS[ind_left],col='red')
  mtext(text = id, side = 3, line = -1)
  
}
```

### Basic slope - individually fit

Use left censored linear regression

```{r}
par(mfrow=c(1,2), cex.lab=1.3, cex.axis=1.3,family='serif')

platcov_dat$clm_slope = NA
platcov_dat$clm_pred = NA
for(id in IDs){
  ind = platcov_dat$ID==id & platcov_dat$Time<Dmax
  if(any(platcov_dat$CT_NS[ind]==40)){
    mod = censReg(Delta_CT ~ Time, data=platcov_dat[ind, ], left = 0)
  } else {
    mod = lm(Delta_CT ~ Time, data=platcov_dat[ind, ])
  }
  platcov_dat$clm_slope[ind] = coef(mod)['Time']
  platcov_dat$clm_pred[ind] = coef(mod)['(Intercept)']+coef(mod)['Time']*platcov_dat$Time[ind]
}
plot(platcov_dat$CT_NS, platcov_dat$Delta_CT-platcov_dat$clm_pred,
     ylab='Residual',xlab='CT')
abline(h=0)
plot(platcov_dat$Time, platcov_dat$Delta_CT-platcov_dat$clm_pred,
     xlim=c(0,7.5),ylab='Residual',xlab='Time')
abline(h=0)

par(mfrow=c(1,1), mar=c(6,4,2,2))
ind = !duplicated(platcov_dat$ID)
boxplot(platcov_dat$clm_slope[ind] ~ platcov_dat$Trt[ind],xlab='',ylab='Slope',las=3)
```
