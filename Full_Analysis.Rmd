---
title: "PLATCOV Statistical Analysis"
author: "James Watson"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, cache.comments = FALSE,
                      echo = F, include = TRUE, 
                      fig.width = 8, fig.height = 8,
                      fig.pos = 'H',dev = 'png', dpi = 300)

library(rstan)
library(lme4)
library(rstanarm)
library(loo)
library(RColorBrewer)
library(censReg)
library(tictoc)
library(reshape2)
library(plotrix)
```

TODO list:

* Sensitivity analysis with very wide priors

## Preambule

This Statistical Analysis Plan (SAP) is written for the PLATCOV trial (registered at ClinicalTrials.gov: https://clinicaltrials.gov/ct2/show/NCT05041907).

Data preparation is done in a different R script called data_prep.R.
This Markdown script assumes that the data are saved in a .csv file *interim_dat.csv* in long format. 
The file *interim_dat.csv* contains the patient clinical and viral load data with the following column headers:

- ID: anonymised patient id code
- Time: time from randomisation
- Trt: treatment allocation as written in CRF
- Site: site at enrollment
- Timepoint_ID: Day of study (integer 0 to 14)
- BARCODE: unique sample id code (in the following format: PLT-site-number-swab type-timepoint)
- Swab_ID: RTS or TSL (right versus left tonsil)
- Plate: unique Plate ID for the PCR assay (matching with plate identifiers in interim_control_dat.csv)
- Rand_date: date of randomisation
- Any_dose: (0/1) any doses of any manufacturer received
- N_dose: integer number of doses received (any manufacturer)
- Antibody_test: 0/1 (negative/positive for SARS-CoV-2 antibody rapid test)
- Weight (kg)
- BMI: kg/weight^2
- Age: (years - has to be between 18-50)
- Sex: 0/1 (male: 1; female/other: 0)
- Symptom_onset: time since onset of symptoms (days)
- Variant: variant of concern (using standard WHO terminology for the main lineages, reference will be the predominant variant in the dataset at the start of the study)
- CT_NS: observed CT value for the N/S gene
- CT_RNaseP: observed CT value for the human RNase P gene
- Per_protocol_sample: whether at the time of sampling the patient was still in per protocol with respect to drug dosing
- IgG: + IgG band on the LFT
- IgM: + IgM band on the LFT
- log10_viral_load: log10 number of viral copies per mL (estimated from control samples using a mixed effects model)
- log10_cens_vl: censoring value


## Computational setup

```{r}
## information on software/hardware used
version
sessionInfo()

study_threshold = 1.125

rstan_options(auto_write = TRUE)
## parameters for the analysis
Dmax = 8
RUN_MODELS = F

source('functions.R')
```

## Load data

```{r}
screen_dat = read.csv('interim_screening_dat.csv')
platcov_dat = read.csv('interim_dat.csv')
ind_na_time = is.na(platcov_dat$Time)
writeLines(sprintf('Missing time for following samples: %s',
                   unique(platcov_dat$ID[ind_na_time])))
platcov_dat$Time[ind_na_time]=platcov_dat$Timepoint_ID[ind_na_time]

ind_neg_time = platcov_dat$Time < 0
writeLines(sprintf('Negative time for following samples: %s',
                   unique(platcov_dat$ID[ind_neg_time])))
platcov_dat$Time[ind_neg_time]=platcov_dat$Timepoint_ID[ind_neg_time]


# make per protocol summary for all patients
PP=merge(aggregate(Timepoint_ID ~ ID+Trt,
                   platcov_dat[platcov_dat$Per_protocol_sample==1, ], max),
         aggregate(Per_protocol_sample ~ ID, platcov_dat, sum),by = 'ID')
PP$Include_mITT = PP$Timepoint_ID>=2


# We remove patients who only have undetectable virus
xx_undetectble = table(platcov_dat$ID, platcov_dat$CT_NS==40)
ids_neg = names(which(xx_undetectble[,1]==0))
writeLines(sprintf('All negative samples for id: %s', ids_neg))

PP$Include_mITT[PP$ID %in% ids_neg] = F

platcov_dat = platcov_dat[!platcov_dat$ID %in% ids_neg, ]
```


## Data summaries

```{r data_summaries}
IDs = unique(platcov_dat$ID)

table(PP$Trt, PP_day = PP$Timepoint_ID)
table(PP$Trt, PP_swabs = PP$Per_protocol_sample)
table(PP$Trt, Include_mITT = PP$Include_mITT)

writeLines(sprintf('We have %s PCR datapoints on %s patients from %s sites',
                   length(unique(platcov_dat$BARCODE)),
                   length(IDs),
                   length(unique(platcov_dat$Site))))

ind_dup = !duplicated(platcov_dat$ID)

platcov_dat$Rand_date = as.POSIXct(platcov_dat$Rand_date)
platcov_dat$Trt_subgroup = platcov_dat$Trt
ind_REGN = platcov_dat$Trt=='Regeneron'
platcov_dat$Trt_subgroup[ind_REGN] = 
  apply(platcov_dat[ind_REGN, c('Trt','Variant')],1,
        function(x) paste0(x[1],' (',x[2],')'))

my_breaks = c(as.POSIXct(c('2021-09-01','2022-01-01')),
              as.POSIXct(format(Sys.time(),
                                '%Y-%m-%d %H:%M:%OS')))

platcov_dat$Epoch = cut(platcov_dat$Rand_date, breaks = my_breaks)
table(platcov_dat$Epoch[ind_dup])

table(platcov_dat$Trt[ind_dup], platcov_dat$Epoch[ind_dup])
platcov_dat$Epoch = as.numeric(as.factor(as.character(platcov_dat$Epoch)))

par(las=1, cex.lab=1.5, cex.axis=1.5, family='serif')
plot(platcov_dat$Rand_date[ind_dup], 1:length(IDs),
     col=platcov_dat$Epoch[ind_dup],
     xlab='Enrollment date', ylab='Patient ID',panel.first=grid())

table(Arm=platcov_dat$Trt[ind_dup], Site = platcov_dat$Site[ind_dup])

platcov_dat$Trt_number = as.numeric(as.factor(platcov_dat$Trt))

writeLines('Age distribution of patients:')
print(aggregate(Age ~ Site, platcov_dat[ind_dup, ], 
                function(x) c(mean = round(mean(x)), min = min(x), max = max(x))))

writeLines('Proportion male (%):')
print(aggregate(Sex ~ Site, platcov_dat[ind_dup, ], function(x) round(100*mean(x))))

writeLines('Proportion vaccinated (%):')
print(aggregate(Any_dose=='Yes' ~ Site, platcov_dat[ind_dup, ], function(x) round(100*mean(x))))

writeLines('Number of vaccine doses by site:')
table(Site=platcov_dat$Site[ind_dup], platcov_dat$N_dose[ind_dup])

writeLines('Number of days since symptom onset by site:')
table(Site=platcov_dat$Site[ind_dup], 
      Sympom_Onset_days = platcov_dat$Symptom_onset[ind_dup])

# baseline samples: taken within 6 hours of randomisation
baseline_ind = platcov_dat$Timepoint_ID==0

bvl = aggregate(log10_viral_load ~ ID + Site, 
                platcov_dat[baseline_ind, ], median)
nrow(bvl) == length(IDs)

writeLines(sprintf('In the %s patients, the geometric mean baseline (defined as samples taken within 6 hours of randomisation) viral load was %s copies per mL (95 percentile interval from %s to %s; range from %s to %s)',
                   length(IDs),
                   round(10^mean(bvl$log10_viral_load)),
                   round(10^(mean(bvl$log10_viral_load)-1.96*sd(bvl$log10_viral_load))),
                   round(10^(mean(bvl$log10_viral_load)+1.96*sd(bvl$log10_viral_load))),
                   round(min(10^bvl$log10_viral_load)),
                   round(max(10^bvl$log10_viral_load))))
```



## Summary data plot

```{r trt_data_plot, fig.width=10, fig.height=7}
par(las=1, cex.lab=1.5, cex.axis=1.5, family='serif', mfrow=c(1,2))
plot_baseline_data(platcov_dat)
mtext(text = 'a',side = 3,adj = 0,cex=1.5,line = 1.5)

trt_cols = brewer.pal(n = length(unique(platcov_dat$Trt)),
                      name = 'Dark2')
plot_serial_data(platcov_dat,trt_cols)
mtext(text = 'b',side = 3,adj = 0,cex=1.5,line = 1.5)
```


## Model fitting
### Specify priors

```{r priors}
source('priors.R')
print(all_priors)
```


### Prepare model

Make stan data set.

Covariates that we use in model 2:

* Vaccination (number of doses)
* Age (standardised to have mean=0 and sd=1)
* Time since symptom onset (days, between 0 and 4)
* Variant (WHO variants of concern) - when available (this is replaced by epoch until we have variant data)
* Serology rapid test (+/-)
* Serum antibody: not yet decided which antibody will be measured - expected May/June 2022


```{r}
## re-arrange so that censored values come last
platcov_dat = dplyr::arrange(platcov_dat, log10_viral_load==log10_cens_vl)
ind_dup = !duplicated(platcov_dat$ID)

trts = c("Regeneron",
         "Ivermectin",
         "Remdesivir",
         "Favipiravir")
platcov_dat$Trt_code = 
  factor(platcov_dat$Trt,
         levels=c("No study drug", trts))

trts_subgroup = c("Regeneron (Delta)",
                  "Regeneron (BA.1)",
                  "Regeneron (BA.2)",
                  "Ivermectin",
                  "Remdesivir",
                  "Favipiravir")
platcov_dat$Trt_code_subgroup = 
  factor(platcov_dat$Trt_subgroup,
         levels=c("No study drug", trts_subgroup))

# Datapoints that will be used in the analysis
ind_fitting = platcov_dat$Time < Dmax & 
  platcov_dat$Per_protocol_sample==1 &
  platcov_dat$ID %in% PP$ID[PP$Include_mITT]

writeLines(sprintf('Total number of datapoints up until day %s is %s',
                   Dmax, sum(ind_fitting)))

covs_base = c('Epoch','Site')
covs_full=c(covs_base,'Age_scaled',
            'Antibody_test','Symptom_onset','N_dose')

stan_inputs_overall = 
  make_stan_inputs(platcov_dat_fit = platcov_dat[ind_fitting,],
                   int_covs_base = covs_base,
                   int_covs_full = covs_full,
                   slope_covs_base = covs_base,
                   slope_covs_full = covs_full,
                   trt_col = 'Trt_code',
                   Dmax = Dmax)

stan_inputs_subgroup = 
  make_stan_inputs(platcov_dat_fit = platcov_dat[ind_fitting,],
                   int_covs_base = covs_base,
                   int_covs_full = covs_full,
                   slope_covs_base = covs_base,
                   slope_covs_full = covs_full,
                   trt_col = 'Trt_code_subgroup',
                   Dmax = Dmax)
```


### Setup model runs

We fit a sequence of Bayesian hierarchical models.
To make sure there are no bugs in the code (all stan code is written specifically for this trial analysis), I fit the following sequence of four models of increasing complexity:

* Model 0: vanilla student-t regression with left censoring at 0 and with individual random effects for slope and intercept;
* Model 1: add the RNaseP measurements;
* Model 2: Add covariate adjustment;
* Model 3: Non-linear model (up and then down) with RNaseP adjustment.


```{r setup_models}
all_mods = list.files('Stan_models',full.names = TRUE,pattern = '*stan')
print(all_mods)
basic_settings = expand.grid(mod = all_mods[1],
                             prior = 1,
                             subgroup = 0:1,
                             cov_matrices = 1)
model_settings = rbind(basic_settings,
                       expand.grid(mod = all_mods[2:3],
                                   prior = 1:length(all_priors),
                                   subgroup = 0:1,
                                   cov_matrices = 1:2))

model_settings$Niter = 3000
model_settings$Nwarmup = 1000
model_settings$Nthin = 5
model_settings$Nchain = 4

writeLines(sprintf('We are running all models with %s chains and %s samples for each chain, discarding half for burn-in and thining every %s, thus giving a total of %s posterior samples per model.',
                   unique(model_settings$Nchain),
                   unique(model_settings$Niter),
                   unique(model_settings$Nthin), 
                   unique(model_settings$Nchain*(model_settings$Niter-model_settings$Nwarmup)/model_settings$Nthin)))


save(model_settings, 
     stan_inputs_overall, 
     stan_inputs_subgroup, 
     all_priors,
     file = 'Rout/model_run_setup.RData')
# all model fitting is run on a cluster using run_models.R (bmrc.sh provides bash commands)
```


Load model fits

```{r}
ff = list.files('Rout/')
ff = ff[grep(pattern = 'model_fits_',x = ff)]
if(!length(ff)==nrow(model_settings)) stop('not all outputs are ready for all model settings')
```


### Model fits: summaries

```{r summary}
key_pars_1 = c('trt_effect', 'alpha_0', 'beta_0',
               'sigma_logvl', 'sigmasq_u', 't_dof')
key_pars_2 = c(key_pars_1, 'gamma_rnasep','slope_coefs', 'intercept_coefs')
key_pars_3 = c(key_pars_2, 'tmax_pop')
key_pars = list(key_pars_1, key_pars_2, key_pars_3)

out_all = list()
out_all_subgroup = list()

for(i in 1:nrow(model_settings)){
  writeLines(sprintf('\n*********************\nSummary of posterior distribution for model %s using priors %s and treatment matrix %s',
                     model_settings$mod[i], 
                     model_settings$prior[i], 
                     model_settings$trt_mat[i]))
  load(paste0('Rout/model_fits_',i,'.RData'))
  out_all[[i]] = out
  kp=key_pars[[which(model_settings$mod[i]==levels(model_settings$mod))]]
  print(summary(out,
                pars=kp)$summary[,c('mean','sd','2.5%','97.5%','n_eff','Rhat')])
  rm(out)
}
```


### Model comparisons using loo

```{r loo}
# loo_out = list()
# for(mm in 1:length(out)){
#   log_lik = extract_log_lik(out[[mm]], merge_chains = FALSE)
#   r_eff = relative_eff(exp(log_lik))
#   loo_out[[mm]] = loo(log_lik, r_eff = r_eff, cores = 2)
#   print(loo_out[[mm]])
# }
# comp = loo_compare(loo_out)
# print(comp) # can set simplify=FALSE for more detailed print output
```


## Results

### Estimated treatment effects under the 4 models

Posterior distributions over the treatment effects for the interventions. Red: no effect; blue: median inferred effect.

```{r treatment_effects}
effect_ests = prob_superior = trt_estimate = list()

for(mm in 1:nrow(model_settings)){
  trt_estimate[[mm]] = exp(colMeans(extract(out_all[[mm]])$trt_effect))
  prob_superior[[mm]] =
    round(100*apply(extract(out_all[[mm]])$trt_effect,
                    2,function(x) mean(x> log(study_threshold))),1)
  effect_ests[[mm]]=
    summary(out_all[[mm]],pars='trt_effect',
            probs = c(0.025, 0.1, 0.9, 0.975))$summary[,c('mean','2.5%','10%','90%','97.5%')]
  
  names(trt_estimate[[mm]]) = trts
  names(prob_superior[[mm]]) = trts
  rownames(effect_ests[[mm]]) = trts
}


writeLines('\n*******************\nMean estimated treatment effects (multiplicative):')
print(trt_estimate)

writeLines('\n*******************\nProbability of super-superiority:')
print(prob_superior)
```


Overall effects

```{r treatment_effect_plot, fig.width=6, fig.height=8}
main_models = which((model_settings$prior==1 & model_settings$cov_matrices==1) |
                      (model_settings$prior==1 & 
                         model_settings$cov_matrices==2 &
                         model_settings$mod==all_mods[2]))
writeLines('The main 4 models with weakly informative priors:')
plot_effect_estimates(effect_ests = effect_ests,
                      plot_models = main_models,
                      names_plot_models = c('Linear: vanilla',
                                            'Linear: RNaseP',
                                            'Non-linear',
                                            'Linear: covariate'))
```


Covariate effects on the intercept (baseline viral load) and slope (viral clearance):

```{r cov_effects,fig.height=5, fig.width=9}
coef_mods = intersect(grep('Linear_model_RNaseP',x = model_settings$mod),
                      which(model_settings$cov_matrices==2 & model_settings$prior==1))
par(mfrow=c(1,2),las=1,family='serif',mar=c(5,7,2,2))
thetas = extract(out_all[[coef_mods]])
alpha_coefs = apply(thetas$intercept_coefs,2,
                    quantile,probs=c(0.025,.1,.5,.9,0.975))
xlims=range(alpha_coefs)

cov_names_intercept =
  plyr::mapvalues(x = colnames(cov_matrices$X_int[[2]]),
                  from = c('Age_scaled','Antibody_test',
                           'Symptom_onset','N_dose','Epoch'),
                  to = c('Age','Serology RDT',
                         'Days since\nsymptom onset',
                         'Number of\nvaccine doses',
                         'Study period'))

cov_names_slope =
  plyr::mapvalues(x = colnames(cov_matrices$X_slope[[2]]),
                  from = c('Age_scaled','Antibody_test',
                           'Symptom_onset','N_dose','Epoch'),
                  to = c('Age','Serology RDT',
                         'Days since\nsymptom onset',
                         'Number of\nvaccine doses',
                         'Study period'))

plot(alpha_coefs['50%', ], 1:ncol(alpha_coefs),
     xlim=xlims,yaxt='n',ylab='',bty='n',xaxt='n',
     panel.first=grid(), xlab='Intercept (fold change)')
abline(v=0,lty=2,lwd=2)
for(i in 1:ncol(alpha_coefs)){
  lines(c(alpha_coefs['10%',i], alpha_coefs['90%',i]),
        c(i,i), lwd=3)
  lines(c(alpha_coefs['2.5%',i], alpha_coefs['97.5%',i]),
        c(i,i), lwd=1)
}
axis(2, at =1:ncol(alpha_coefs), labels = cov_names_intercept,tick = F)
x_points = round(10^seq(xlims[1], xlims[2],length.out = 5),1)
axis(1, at = log10(x_points), labels = x_points)

beta_coefs = apply(thetas$slope_coefs,2,quantile,
                   probs=c(0.025,.1,.5,.9,0.975))
xlims=range(beta_coefs)
plot(beta_coefs['50%', ], 1:ncol(beta_coefs),
     xlim=xlims,yaxt='n',ylab='',bty='n',xaxt='n',
     panel.first=grid(), xlab='Slope (multiplicative effect)')
abline(v=0,lty=2,lwd=2)
for(i in 1:ncol(beta_coefs)){
  lines(c(beta_coefs['10%',i], beta_coefs['90%',i]),
        c(i,i), lwd=3)
  lines(c(beta_coefs['2.5%',i], beta_coefs['97.5%',i]),
        c(i,i), lwd=1)
}
axis(2, at =1:ncol(beta_coefs), labels = cov_names_slope, tick = F)
x_points = round(10^seq(xlims[1], xlims[2],length.out = 5),1)
axis(1, at = log10(x_points), labels = x_points)
```

### Slopes over time

Plot the absolute slope estimate for each individual over time

```{r slopes_over_time}
slope_model = which(model_settings$mod==all_mods[2]&
                      model_settings$prior==1 &
                      model_settings$cov_matrices==1)

names(trt_cols)=c('No study drug', trts)
par(mfrow=c(3,1), mar = c(3,5,0.5,1),las=1,
    family='serif', cex.lab=1.5, cex.axis=1.5)
trt_allocations=platcov_dat_fit$Trt_code[analysis_data_stan$ind_start]
rand_date = platcov_dat_fit$Rand_date[analysis_data_stan$ind_start]

writeLines(sprintf('Slopes plot for model setting %s', slope_model))
print(model_settings[slope_model, ])

slopes = abs(extract(out_all[[slope_model]])$slope)
ymax = max(apply(slopes,2,quantile,.975))
my_y_vals = seq(0, ymax, length.out = 4)
my_y_labels = round(10^my_y_vals)
trts_comp = c('Regeneron','Ivermectin')

iq_slopes = rowMeans(apply(slopes[,trt_allocations=='No study drug'],
                           1, quantile,
                           probs = c(.1,.9)))

for(tt in c('No study drug', trts_comp)){
  ind = grep(pattern = tt,x = trt_allocations)
  plot(rand_date[ind], colMeans(slopes[,ind]),
       col=trt_cols[trt_allocations[ind]],
       xlab='', xaxt='n', yaxt='n',
       ylim=c(0,ymax),panel.first=grid(),
       ylab='Fold change per day', xlim=range(rand_date),pch=16)
  
  
  abline(v = as.POSIXct('2021-12-17'),h=iq_slopes,lty=2)
  axis(2, at=my_y_vals, labels = my_y_labels)
  if(tt == 'Regeneron'){
    text(x = as.POSIXct('2022-02-01'),y = 1.2,
         labels = paste0(tt,' (n=',length(ind),')'),cex=2)
  } else {
    text(x = as.POSIXct('2021-11-15'),y = 1.2,
         labels = paste0(tt,' (n=',length(ind),')'),cex=2)
  }
  
  for(i in ind){
    lines(rep(rand_date[i],2), 
          quantile(slopes[,i],probs = c(0.025,0.975)),
          col=trt_cols[trt_allocations[i]])
  }
  
  axis(1, at = c(as.POSIXct(c('2021-10-01',
                              # '2021-11-01',
                              '2021-12-01',
                              # '2022-01-01',
                              '2022-02-01',
                              '2022-03-27'))), 
       labels = c('Oct','Dec','Feb','Apr'))
}
```


Plot the individual slope estimates by group

```{r slopes_by_group}
slopes = abs(extract(out_all[[slope_model]])$slope)
ind_unique = analysis_data_stan$ind_start
trt_summary_dat = 
  data.frame(trt = as.character(platcov_dat_fit$Trt_code[ind_unique]),
             epoch = platcov_dat_fit$Epoch[ind_unique],
             slope_mean = colMeans(slopes),
             slope_upper = apply(slopes, 2, quantile, probs=0.1),
             slope_lower = apply(slopes, 2, quantile, probs=0.9),
             col = trt_cols[as.numeric(platcov_dat_fit$Trt_code[ind_unique])],
             BMI = platcov_dat_fit$BMI[ind_unique],
             sex = platcov_dat_fit$Sex[ind_unique],
             symptom_onset = platcov_dat_fit$Symptom_onset[ind_unique],
             age = platcov_dat_fit$Age[ind_unique])

trt_summary_dat = dplyr::arrange(trt_summary_dat, trt, slope_mean)
par( mar = c(5,12,2,2),las=1,
     family='serif', cex.lab=1.3, cex.axis=1.3)

xlims = c(min(trt_summary_dat$slope_upper),
          max(trt_summary_dat$slope_lower))
my_x_vals = seq(xlims[1], xlims[2], length.out = 4)
my_x_labels = round(10^my_x_vals)
plot(trt_summary_dat$slope_mean, 1:nrow(trt_summary_dat),
     col=trt_summary_dat$col, yaxt='n', xaxt='n',
     xlim=xlims, panel.first=grid(),
     xlab='Fold change per day', pch=16, ylab='')
axis(1, at = my_x_vals,labels = my_x_labels)
abline(v = quantile(trt_summary_dat$slope_mean[trt_summary_dat$trt=='No study drug'],probs = c(0.1,0.5,0.9)), lty=c(2,1,2))

for(i in 1:nrow(trt_summary_dat)){
  lines(c(trt_summary_dat$slope_upper[i], trt_summary_dat$slope_lower[i]),
        rep(i,2),col=trt_summary_dat$col[i])
}
for(tt in unique(trt_summary_dat$trt)){
  mid_point = median(which(trt_summary_dat$trt==tt))
  axis(2, at = mid_point, labels = tt, col = trt_cols, tick = F)
}
```


Some exploratory covariate analyses

```{r}
summary(lm(slope_mean ~ trt ,
           #+ sex + BMI + age + symptom_onset, 
           trt_summary_dat))
```




### Individual plots

Individual plots colored by model

```{r individ_fits}
par(las=1, mfrow=c(4,4), mar=c(4,3,1,1),bty='n', 
    cex.lab=1.5, cex.axis=1.5,family='serif')
id = counter = 1
K_plots = 16
mod_plot = c(2,3)
set.seed(46465);mod_cols = sample(brewer.pal(n = 9, name = 'Set1'))

thetas = list()
for(mm in 1:length(out_all)){
  thetas[[mm]] = extract(out_all[[mm]])
}
while(id <= max(ID_map$ID_stan)){
  
  # every K_plots put a legend in bottom right panel
  if(counter %% K_plots == 0){
    plot(NA,NA,xlab='',ylab='',xaxt='n',
         yaxt='n',xlim=c(0,1),ylim=c(0,1))
    legend('left', col = mod_cols[mod_plot],lwd=1,
           inset=0.03,bty='n',
           legend = c('Standard',
                      'Non-linear'),
           cex=1.1,title = 'Model')
  } else {
    # draw individual model fit with data
    ind = analysis_data_stan$id==id
    plot(analysis_data_stan$obs_day[ind],
         analysis_data_stan$log_10_vl[ind],xlab='',
         ylab='', panel.first=grid(),xlim=c(0,7),
         ylim = range(analysis_data_stan$log_10_vl))
    for(mm in mod_plot){
      ix = order(analysis_data_stan$obs_day[ind])
      my_xs = analysis_data_stan$obs_day[ind][ix]
      polygon(x = c(my_xs, rev(my_xs)),
              y = c(apply(thetas[[mm]]$preds[,ind],2,
                          quantile,probs=0.025)[ix],
                    rev(apply(thetas[[mm]]$preds[,ind],2,
                              quantile,probs=0.975)[ix])),
              border = NA, 
              col = adjustcolor(mod_cols[mm],alpha.f = .3))
      lines(my_xs,
            colMeans(thetas[[mm]]$preds[,ind])[ix],
            col = mod_cols[mm],lwd=2)
    }
    points(analysis_data_stan$obs_day[ind],
           analysis_data_stan$log_10_vl[ind],pch=16)
    id_real = ID_map$ID_key[ID_map$ID_stan==id][1]
    mtext(text = paste(id_real,
                       unique(platcov_dat_fit$Trt[platcov_dat_fit$ID==id_real]),
                       sep = ' '),
          side = 3, line = -0.2, cex=0.8)
    id=id+1
  }
  counter=counter+1
}
```


## Sensitivity analysis

### Treatment effects

```{r treatment_effect_sensitivity}
mylty = rep(1,9)
mylty[model_settings$mod==all_mods[3]]=2
plot_effect_estimates(effect_ests = effect_ests,
                      plot_models = 1:9,
                      names_plot_models = 1:9,mylty = mylty)
```



### Left vs right tonsil

```{r left_versus_right}
par(las=1, bty='n', cex.lab=1.5,
    cex.axis=1.5,family='serif',mfrow=c(2,2))

dd_CT_NS = dcast(platcov_dat[,c('ID','Timepoint_ID',
                                'Swab_ID','CT_NS')],
                 ID+Timepoint_ID~Swab_ID,
                 value.var="CT_NS",
                 fun.aggregate = mean)

dd_RNaseP = dcast(platcov_dat[,c('ID','Timepoint_ID',
                                 'Swab_ID','CT_RNaseP')],
                  ID+Timepoint_ID~Swab_ID,
                  value.var="CT_RNaseP",
                  fun.aggregate = mean)

plot((dd_CT_NS$RTS+dd_CT_NS$TSL)/2, 
     dd_CT_NS$RTS-dd_CT_NS$TSL,
     xlab='Mean viral CT (left & right)', 
     ylab='Difference in viral CT (left-right)',
     panel.first=grid())
hist(dd_CT_NS$RTS-dd_CT_NS$TSL, breaks=50,main='',
     xlab='Difference in viral CT (left-right)')
plot((dd_RNaseP$RTS+dd_RNaseP$TSL)/2,
     dd_RNaseP$RTS-dd_RNaseP$TSL,
     xlab='Mean RNaseP CT (left & right)', 
     ylab='Difference in RNaseP CT (left-right)',
     panel.first=grid())
hist(dd_RNaseP$RTS-dd_RNaseP$TSL,breaks = 50,main='',
     xlab='Difference in RNaseP CT (left-right)')

par(mfrow=c(1,1))
plot(dd_RNaseP$RTS-dd_RNaseP$TSL, 
     dd_CT_NS$RTS-dd_CT_NS$TSL,
     xlab='Difference in RNaseP CT (left-right)',
     ylab='Difference in viral CT (left-right)',
     panel.first=grid())
cor_out = cor.test(dd_RNaseP$RTS-dd_RNaseP$TSL, 
                   dd_CT_NS$RTS-dd_CT_NS$TSL)
mtext(text = sprintf('Pearson correlation is %s',signif(cor_out$estimate,2)),side = 3,line = 0)
```


### Human RNaseP

```{r RNaseP}
par(las=1, cex.lab=1.5, cex.axis=1.5,family='serif')
hist(platcov_dat$CT_RNaseP, main='',
     xlab='RNaseP CT',ylab='',yaxt='n', breaks = 30)
abline(v = mean(platcov_dat$CT_RNaseP) + c(1.96,-1.96)*sd(platcov_dat$CT_RNaseP),
       lwd=3, lty=2)
writeLines(sprintf('the standard deviation of the RNaseP CT distribution is %s.', 
                   round(sd(platcov_dat$CT_RNaseP),2)))
writeLines(sprintf('95%% of the distribution is within %s CT values difference',
                   round(diff(mean(platcov_dat$CT_RNaseP) + c(-1.96,1.96)*sd(platcov_dat$CT_RNaseP)),2)))
```


### Quality Control for PCR

```{r PCR_QC}
par(las=1, mfrow=c(2,2), cex.lab=1.5, cex.axis=1.5,family='serif')
plot(control_dat$log10_true_density,control_dat$CT_NS, 
     ylab='CT value', 
     xlab='Control viral density (log10 copies/mL)',
     panel.first=grid(),
     col=as.numeric(as.factor(control_dat$Plate)), ylim=c(40,18))
my_slope_coefs = array(dim = c(length(unique(control_dat$Plate)),2))

for(ss in unique(control_dat$Plate)){
  plate_ind = control_dat$Plate==ss
  mod = lm(CT_NS~log10_true_density, control_dat[plate_ind, ])
  abline(mod,col = control_dat$Plate[plate_ind])
  my_slope_coefs[which(ss==unique(control_dat$Plate)),]=coef(mod)
}

hist(my_slope_coefs[,1], xlab='Intercept', main='')
writeLines(sprintf('SD of the intercept is %s',round(sd(my_slope_coefs[,1]),2)))

hist(my_slope_coefs[,2], xlab='Slope', main='')
writeLines(sprintf('Maximum difference in CT values for a tenfold change in viral load is %s',round(diff(range(my_slope_coefs[,2])),2)))

xx = aggregate(CT_NS ~ Plate + log10_true_density, 
               data = control_dat, 
               function(x) c(mean(x), diff(x)))
par(las=1)
plot(xx$CT[,1], xx$CT[,2], 
     xlab = 'Mean CT',
     ylab = 'CT Difference from duplicates',
     panel.first=grid())
abline(h = 0)

xx$Mean_CT = cut(xx$CT[,1],breaks = seq(20, 40, by=5),include.lowest = T)
xx$Diff_CT = xx$CT[,2]

par(mfrow=c(1,1))
yy = aggregate(Diff_CT ~ Mean_CT, xx, sd)
plot(yy$Mean_CT, sqrt(2) * yy$Diff_CT, xlab='CT interval',
     ylab = 'Estimated measurement error (standard deviation)')
```




